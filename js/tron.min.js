
$(function(){(function(a){var b={_config:{startingScene:"Main",explosionTimeout:1500,trailTimeout:10000,logging:true,assetPaths:{audio:"audio/",images:"images/"},assetLoadHandlers:{onLoad:function(){Crafty.log("Assets loaded")},onProgress:function(c){Crafty.log("Assets loaded: "+Math.round(c.percent)+"%")},onError:function(c){Crafty.log("Error loading "+c)}}},_instance:null,_assetsLoaded:false,_componentsDefined:false,_paused:false,_canvas:null,_scenes:[],_assets:{imags:["logo_nobg.png"],sprites:{"bike_cyan.png":{tile:32,tileh:32,map:{Sprite_BikeCyan:[0,0]}},"bike_orange.png":{tile:32,tileh:32,map:{Sprite_BikeOrange:[0,0]}},"explosion.png":{tile:64,tileh:64,map:{Sprite_Explosion_0:[0,0],Sprite_Explosion_1:[1,0],Sprite_Explosion_2:[2,0],Sprite_Explosion_3:[3,0],Sprite_Explosion_4:[4,0],Sprite_Explosion_5:[5,0],}},"trail.png":{tile:32,tileh:32,map:{Sprite_Trail:[0,0]}},"speaker.png":{tile:512,tileh:512,map:{Sprite_SpeakerActive:[0,0],Sprite_SpeakerMuted:[1,0]}}},audio:{Background:["run_wild_edited.mp3"],Explosion:["explosion.mp3"]}},instance:function(){if(!b._instance){b._instance=Object.create(b)}return b._instance},init:function(c){Crafty.logginEnabled=b._config.logging;Crafty.log("Initialising Tron");this._setupCanvas(c);this._defineComponents();this._loadAssets();return this},start:function(){Crafty.log("Starting Tron");this.enterScene("Main",this);return this},startWhenLoaded:function(c){if(!b._assetsLoaded){Crafty.log("Still waiting for assets to load...");setTimeout(b.startWhenLoaded,1000,c);return}c.start()},unload:function(c){Crafty.log("Unloading game");c=(typeof c==="undefined"?false:c);Crafty.audio.stop();Crafty.stop(c);return this},pause:function(){Crafty.log("Pausing game");if(!this._paused){Crafty.pause();this._paused=!this._paused}return this},unpause:function(){Crafty.log("Unpausing game");if(this._paused){Crafty.pause();this._paused=!this._paused}return this},isPaused:function(){return this._paused},addScene:function(c,d){b._scenes.push(c);Crafty.defineScene(c,d)},enterScene:function(c,d){if(b._scenes.indexOf(c)===-1){Crafty.error("Scene undefined: "+c)}else{Crafty.log("Entering Scene: "+c);Crafty.enterScene(c,d)}},setConfig:function(c){c=c||{};for(var d in c){b._config[d]=c[d]}},_setupCanvas:function(c){this._canvas=document.getElementById(c);if(this._canvas&&typeof this._canvas!=="undefined"&&this._canvas.attributes.hasOwnProperty("tron-height")&&this._canvas.attributes.hasOwnProperty("tron-width")){Crafty.log("Setting up canvas with predefined properties");Crafty.init(this._canvas.attributes.getNamedItem("tron-width").value*1,this._canvas.attributes.getNamedItem("tron-height").value*1,this._canvas)}else{Crafty.log("Setting up default canvas");Crafty.init()}},_loadAssets:function(c,e,d){if(!b._assetsLoaded){c=c||this._config.assetLoadHandlers.onLoad;e=e||this._config.assetLoadHandlers.onProgress;d=d||this._config.assetLoadHandlers.onError;Crafty.paths(b._config.assetPaths);Crafty.load(this._assets,function(){b._assetsLoaded=true;c()},e,d)}},_defineComponents:function(){if(!b._componentsDefined){Crafty.c("Square",{required:"2D, Canvas, Color"});Crafty.c("DebugPoint",{required:"Square",init:function(){this.h=2;this.w=2;this.color("red")}});Crafty.c("Trail",{required:"Square, Collision, Tween",_player:null,_active:false,init:function(){this.h=6;this.w=1;this.origin("center");this.checkHits("Player");this.z=5;setTimeout(function(c){c.activate()},200,this)},events:{HitOn:function(c){var d=c[0].obj;if(d.has("Player")&&this._active){d.explode()}}},setPlayer:function(c){this._player=c;return this},getPlayer:function(){return this._player},isActive:function(){return this._active},activate:function(){this._active=true;setTimeout(function(c){c.tween({alpha:0},500,"easeOutQuad");setTimeout(function(d){d.getPlayer().removeTrail(d);d.destroy()},500,c)},b._config.trailTimeout,this);return this}});Crafty.c("Player",{required:"2D, Canvas, Collision",_absoluteCentre:{x:0,y:0},_vector:new Crafty.math.Vector2D(),_magnitude:1,_trailRequiredMagnitude:150,_trail:[],_trailColour:"red",_lock:false,init:function(){this.origin("center");this.checkHits("Player","Trail");this.z=10;this.collision([10,0,10,32,22,32,22,0,])},events:{EnterFrame:function(){if(this.x>Crafty.viewport.width+this.h){this.x=0-this.h}if(this.x<0-this.h){this.x=Crafty.viewport.width}if(this.y>Crafty.viewport.height+this.h){this.y=0-this.h}if(this.y<0-this.h){this.y=Crafty.viewport.height}this._vector.x=Math.sin(Crafty.math.degToRad(this._rotation));this._vector.y=-Math.cos(Crafty.math.degToRad(this._rotation));this._absoluteCentre.x=this.x+this._origin.x;this._absoluteCentre.y=this.y+this._origin.y},HitOn:function(c){if(c[0].obj.has("Player")){this.explode()}},Move:function(d){if(!this.isLocked()){if(this._magnitude>=this._trailRequiredMagnitude){var c=Crafty.e("Trail").attr({x:(this._absoluteCentre.x),y:(this._absoluteCentre.y-2),rotation:this.rotation}).color(this._trailColour).setPlayer(this);this._trail.push(c)}}}},lock:function(c){this._lock=c||true;return this},isLocked:function(){return this._lock},explode:function(){if(!this.isLocked()){this.lock();this.rotate=0;var c=Crafty.e("Explosion");c.attr({x:this.x-16,y:this.y-16});setTimeout(function(d){d.destroy()},100,this)}},removeTrail:function(c){var d=this._trail.indexOf(c);if(d>-1){this._trail.splice(d,1)}return this}});Crafty.c("OrangePlayer",{required:"Player, Sprite_BikeOrange",init:function(){this._trailColour="rgb(255, 120, 0)"}});Crafty.c("CyanPlayer",{required:"Player, Sprite_BikeCyan",init:function(){this._trailColour="cyan"}});Crafty.c("ControllablePlayer",{required:"Player, Motion, Keyboard",_maxMagnitude:300,_magnitudeIncrement:5,_rotationSpeed:7,_keysPressed:{UP:false,LEFT:false,RIGHT:false,},init:function(){this.origin("center")},events:{KeyDown:function(c){if(c.keyCode===Crafty.keys.RIGHT_ARROW){this._keysPressed.RIGHT=true}if(c.keyCode===Crafty.keys.LEFT_ARROW){this._keysPressed.LEFT=true}if(c.keyCode===Crafty.keys.UP_ARROW){this._keysPressed.UP=true}},KeyUp:function(c){if(c.keyCode===Crafty.keys.RIGHT_ARROW){this._keysPressed.RIGHT=false}if(c.keyCode===Crafty.keys.LEFT_ARROW){this._keysPressed.LEFT=false}if(c.keyCode===Crafty.keys.UP_ARROW){this._keysPressed.UP=false}},EnterFrame:function(){if(!this.isLocked()){if(!(this._keysPressed.LEFT&&this._keysPressed.RIGHT)&&(this._keysPressed.LEFT||this._keysPressed.RIGHT)){if(this._keysPressed.LEFT){this.rotation-=this._rotationSpeed}if(this._keysPressed.RIGHT){this.rotation+=this._rotationSpeed}}if(this._keysPressed.UP){if(this._magnitude<=this._maxMagnitude){this._magnitude+=this._magnitudeIncrement}this._vector.scaleToMagnitude(this._magnitude);this.vx=this._vector.x;this.vy=this._vector.y}else{if(this._magnitude>1){this._magnitude-=this._magnitudeIncrement}if(this._magnitude<=1){this._magnitude=1;this.vx=0;this.vy=0}else{this._vector.scaleToMagnitude(this._magnitude);this.vx=this._vector.x;this.vy=this._vector.y}}}else{this.vx=0;this.vy=0}}},isMoving:function(){var c=this.velocity();return(c.x!==0||c.y!==0)},});Crafty.c("Explosion",{required:"Sprite_Explosion_0, Canvas, SpriteAnimation, Tween",init:function(){this.origin("center");this.z=20;this.rotation=Crafty.math.randomNumber(0,359);Crafty.audio.play("Explosion",1,0.05);this.reel("ExplosionAnimation",250,0,0,6).animate("ExplosionAnimation");setTimeout(function(c){c.tween({alpha:0},500)},b._config.explosionTimeout-500,this);setTimeout(function(c){c.destroy()},b._config.explosionTimeout,this)}});Crafty.c("SpeakerControl",{required:"2D, DOM, Sprite_SpeakerActive, Mouse",_audioID:null,_pause:false,init:function(){this.h=32;this.w=32;this.alpha=0.15},events:{NewComponent:function(){this.h=32;this.w=32},Click:function(c){if(this._audioID){if(!this._paused){this.pause()}else{this.unpause()}}else{Crafty.log("No audio ID set")}}},setAudioID:function(d){this._audioID=d;var c=$.cookie(this._audioID);if(c!=="undefined"){if(c==="false"){this.pause()}}return this},pause:function(){this._paused=true;Crafty.audio.pause(this._audioID);this.removeComponent("Sprite_SpeakerActive").addComponent("Sprite_SpeakerMuted");$.cookie(this._audioID,false,{expires:30})},unpause:function(){this._paused=false;Crafty.audio.unpause(this._audioID);this.removeComponent("Sprite_SpeakerMuted").addComponent("Sprite_SpeakerActive");$.cookie(this._audioID,true,{expires:30})}});b._componentsDefined=true}}};b.addScene("LandingPage",function(c){Crafty.background("rgb(40, 40, 40)");Crafty.audio.play("Background",-1,0.1);Crafty.e("SpeakerControl").attr({x:Crafty.viewport.width-64,y:32}).setAudioID("Background");Crafty.e("2D, Text, DOM").attr({h:50,w:400,x:Crafty.viewport.width/2-180,y:Crafty.viewport.height/2+80,}).text("Lets play!").textColor("rgba(255, 255, 255, 0.1)").textFont({font:"Impact, Charcoal, sans-serif",size:"30pt",weight:"bold"}).css({"text-align":"center",});Crafty.log("Using Logo Measurements: 758, 302");Crafty.e("2D, HTML, Mouse").attr({x:Crafty.viewport.width/2-379,y:Crafty.viewport.height/2-151,h:302,w:758}).append('<img src="'+b._config.assetPaths.images+'logo_nobg.png" />').bind("Click",function(){Crafty.log("Clicked");Crafty.audio.stop();c.start()}).bind("MouseOver",function(){this.css("cursor","pointer")});var d=Math.round(Crafty.viewport.height/300*Crafty.viewport.width/300*6);Crafty.e("2D, Canvas, Particles").particles({maxParticles:d,size:30,sizeRandom:20,speed:0.2,speedRandom:0.8,lifeSpan:75,lifeSpanRandom:5,angle:180,angleRandom:50,startColour:[40,40,40,1],startColourRandom:[0,0,0,5],endColour:[60,60,60,0],endColourRandom:[0,0,0,0],sharpness:80,sharpnessRandom:10,spread:Crafty.viewport.width/2,duration:-1,fastMode:true,gravity:{x:0,y:0},jitter:0.5,originOffset:{x:Crafty.viewport.width/2,y:Crafty.viewport.height/2},backgroundLayer:true,});Crafty.e("CyanPlayer").attr({x:Crafty.viewport.width/2+150,y:Crafty.viewport.height/2-120,rotation:110});Crafty.e("OrangePlayer").attr({x:Crafty.viewport.width/2-150,y:Crafty.viewport.height/2+110,rotation:340})});b.addScene("Main",function(){Crafty.background('rgb(40, 40, 40) url("images/bg.png") center no-repeat');var c=Math.round(Crafty.viewport.height/300*Crafty.viewport.width/300*6);Crafty.log(c);Crafty.e("2D, Canvas, Particles").particles({maxParticles:c,size:30,sizeRandom:20,speed:0.2,speedRandom:0.8,lifeSpan:75,lifeSpanRandom:5,angle:180,angleRandom:50,startColour:[40,40,40,1],startColourRandom:[0,0,0,5],endColour:[60,60,60,0],endColourRandom:[0,0,0,0],sharpness:80,sharpnessRandom:10,spread:Crafty.viewport.width/2,duration:-1,fastMode:true,gravity:{x:0,y:0},jitter:0.5,originOffset:{x:Crafty.viewport.width/2,y:Crafty.viewport.height/2},backgroundLayer:true,});Crafty.e("CyanPlayer, ControllablePlayer").attr({x:100,y:100,rotation:90})});b.addScene("Debug",function(){Crafty.background('rgb(40, 40, 40) url("images/bg.png") center no-repeat');var d=Math.round(Crafty.viewport.height/300*Crafty.viewport.width/300*6);Crafty.e("2D, Canvas, Particles").particles({maxParticles:d,size:30,sizeRandom:20,speed:0.2,speedRandom:0.8,lifeSpan:75,lifeSpanRandom:5,angle:180,angleRandom:50,startColour:[40,40,40,1],startColourRandom:[0,0,0,5],endColour:[60,60,60,0],endColourRandom:[0,0,0,0],sharpness:80,sharpnessRandom:10,spread:Crafty.viewport.width/2,duration:-1,fastMode:true,gravity:{x:0,y:0},jitter:0.5,originOffset:{x:Crafty.viewport.width/2,y:Crafty.viewport.height/2},backgroundLayer:true,});Crafty.e("CyanPlayer, ControllablePlayer").attr({x:100,y:100,rotation:90});for(var c=0;c<5;c++){Crafty.e("OrangePlayer").attr({x:Crafty.math.randomNumber(150,Crafty.viewport.width),y:Crafty.math.randomNumber(0,Crafty.viewport.height),rotation:Crafty.math.randomNumber(0,359)})}});a.Tron=b})(window)});